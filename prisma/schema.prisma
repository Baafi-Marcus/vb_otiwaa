generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_6TkJ3hExvyez@ep-damp-wildflower-ah9zhgrw-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require"
}

model Merchant {
  id                    String         @id @default(uuid())
  name                  String
  whatsappPhoneNumberId String?        // Made Optional for Centralized Pivot
  systemPrompt          String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  baseDeliveryFee       Decimal        @default(0) @db.Decimal(10, 2)
  category              String?
  clientVision          String?
  isClosed              Boolean        @default(false)
  location              String?
  menuImageUrl          String?
  operatingHours        String?
  paymentMethods        String?
  twilioPhoneNumber     String?        // Made Optional
  password              String?
  tier                  String         @default("BASIC")
  tierExpiresAt         DateTime?
  monthlyOrderCount     Int            @default(0)
  lastOrderCountReset   DateTime       @default(now())
  logoUrl               String?
  contactPhone          String?        // CRITICAL: Used for order alerts
  contactEmail          String?
  nudgeDays             Int            @default(2)
  nudgeMessage          String?
  campaigns             Campaign[]
  customers             Customer[]
  deliveryZones         DeliveryZone[]
  orders                Order[]
  catalog               Product[]
  upgradeRequests       UpgradeRequest[]
  messages              Message[]
}

model Campaign {
  id         String        @id @default(uuid())
  merchantId String
  name       String
  message    String
  status     String        @default("PENDING")
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  merchant   Merchant      @relation(fields: [merchantId], references: [id])
  logs       CampaignLog[]
}

model CampaignLog {
  id         String   @id @default(uuid())
  campaignId String
  customerId String
  status     String
  error      String?
  createdAt  DateTime @default(now())
  campaign   Campaign @relation(fields: [campaignId], references: [id])
}

model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  phone     String?  // New: For WhatsApp alerts
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiKey {
  id        String   @id @default(uuid())
  provider  String
  key       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeliveryZone {
  id         String   @id @default(uuid())
  name       String
  price      Decimal  @db.Decimal(10, 2)
  merchantId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  merchant   Merchant @relation(fields: [merchantId], references: [id])
}

model Product {
  id          String      @id @default(uuid())
  name        String
  description String?
  price       Decimal     @db.Decimal(10, 2)
  category    String?
  imageUrl    String?
  merchantId  String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  stockQuantity Int       @default(0)
  trackStock    Boolean   @default(false)
  orderItems  OrderItem[]
  merchant    Merchant    @relation(fields: [merchantId], references: [id])
}

model Order {
  id              String      @id @default(uuid())
  customerName    String
  customerPhone   String
  merchantId      String
  totalAmount     Decimal     @db.Decimal(10, 2)
  status          String      @default("PENDING")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deliveryFee     Decimal     @default(0) @db.Decimal(10, 2)
  fulfillmentMode String?
  customerId      String?
  location        String?
  shortId         String?     @unique
  paymentScreenshotUrl String?
  paymentStatus        String      @default("NONE") // NONE, PENDING, VERIFIED, REJECTED
  customer        Customer    @relation(fields: [customerPhone], references: [phoneNumber])
  merchant        Merchant    @relation(fields: [merchantId], references: [id])
  items           OrderItem[]
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model Customer {
  id                String    @id @default(uuid())
  phoneNumber       String    @unique
  name              String?
  lastSeen          DateTime  @default(now())
  merchantId        String?   // Made Optional (User can be in 'Directory Mode')
  currentMerchantId String?   // NEW: Session state tracking which store they are in
  botPaused         Boolean   @default(false)
  lastNudgedAt      DateTime?
  merchant          Merchant? @relation(fields: [merchantId], references: [id])
  orders            Order[]
  messages          Message[]
}

model StoredImage {
  id        String   @id @default(uuid())
  data      Bytes
  mimeType  String
  filename  String
  createdAt DateTime @default(now())
}

model ConversationalContext {
  id          String   @id @default(uuid())
  phoneNumber String   @unique
  context     Json
  updatedAt   DateTime @updatedAt
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model WebhookLog {
  id        String   @id @default(uuid())
  provider  String   @default("TWILIO")
  payload   Json
  createdAt DateTime @default(now())
}

model AdminNotification {
  id          String   @id @default(uuid())
  type        String   // TIER_EXPIRED, UPGRADE_REQUEST, ORDER_LIMIT_EXCEEDED
  priority    String   @default("NORMAL") // INFO, NORMAL, CRITICAL
  title       String
  message     String
  merchantId  String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model UpgradeRequest {
  id            String   @id @default(uuid())
  merchantId    String
  currentTier   String
  requestedTier String
  status        String   @default("PENDING")
  createdAt     DateTime @default(now())
  merchant      Merchant @relation(fields: [merchantId], references: [id])
}

model Message {
  id            String   @id @default(uuid())
  merchantId    String
  customerPhone String
  direction     String   // INBOUND, OUTBOUND
  content       String
  status        String   @default("SENT") // SENT, RECEIVED, FAILED
  createdAt     DateTime @default(now())
  
  merchant      Merchant @relation(fields: [merchantId], references: [id])
  customer      Customer @relation(fields: [customerPhone], references: [phoneNumber])

  @@index([merchantId, customerPhone])
}
